var update_label_map=function(e){for(var n=Object.keys(e),a=0;a<n.length;++a){e[n[a]]+=2}return e},scopes=[],get_scopes_top=function(){return scopes[scopes.length-1]},del_scopes_top=function(){return scopes.pop()},get_cur_scope=function(){return get_scopes_top().scope},get_cur_func_name=function(){return get_scopes_top().function_name},dot_function=function(e){var n=e[1];log("函数名:",n);var a=new Map;a.function_name=n;for(var t=new Map,r="#"+n,o=e.slice(2),s=0;s<o.length;++s){t[o[s]]=0,update_label_map(t)}return a.scope=t,scopes.push(a),r},dot_end_function=function(e){var n="#end_"+e[1];return del_scopes_top(),n},dot_var=function(e){var n=get_cur_scope();if(!(e.length<2)){var a=e[1],t=0;null!=n[a]&&assert(!1,"变量已定义"),3==e.length&&(t=e[2]),n[a]=0;var r="set2 a3 "+t+"\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n";return update_label_map(n),r}assert(!1,".var语法错误")},dot_load=function(e){var n=get_cur_scope(),a=e[1],t=e[2];return"\nset2 a3 "+n[a]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 "+t},dot_assign=function(e){var n=get_cur_scope(),a=e[1];return"set2 a3 "+n[e[2]]+"\nsubtract2 f1 a3 a3\nsave_from_register2 "+a+" a3 "},dot_call_function=function(e){for(var n=e[1],a=e.slice(2),t=get_cur_scope(),r=0,o=0,s=0;s<a.length;++s)isDigit(a[s])?o+=15:r+=22;var _=r+o+14;update_label_map(t);var f="set2 a3 "+_+"\nadd2 pa a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n";for(s=0;s<a.length;++s){if(isDigit(a[s]))o+=15;else f+="\nset2 a3 "+t[a[s]]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n",update_label_map(t)}return f+="jump #"+n,log("scopes:",scopes),f},dot_return_func=function(e){var n=get_cur_scope(),a=2*Object.keys(n).length,t=null;e.length>=2&&(t=e[1]);var r="";null!=t?null!=n[t]&&(r="set2 a3 "+n[t]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 a1\nset2 a3 "+a+"\nsubtract2 f1 a3 f1 ;f1退栈\nsave_from_register2 a1 f1\nset2 a3 2\nsubtract2 f1 a3 f1 ;再移回到返回值位置\nload_from_register2 f1 a3\njump_from_register a3\n"):r="main"==get_cur_func_name()?"set2 a3 "+a+"\nsubtract2 f1 a3 f1 ;f1退栈\n":"set2 a3 "+(a+=2)+"\nsubtract2 f1 a3 f1 ;f1退栈\nload_from_register2 f1 a3\njump_from_register a3\n";return r},dot_load_return=function(e){var n=get_cur_scope();if(!(e.length<2)){var a=e[1];null!=n[a]&&assert(!1,"load_return中变量未定义"),n[a]=0;return update_label_map(n),"\nset2 a3 2\nadd2 f1 a3 a3\nload_from_register2 a3 a3\nsave_from_register2 a3 f1 ;把值放到f1处\nset2 a3 2\nadd2 f1 a3 f1\n"}assert(!1,".load_return语法错误")},dot_add=function(e){e.length<4&&assert(!1,"add语法出错");var n=get_cur_scope(),a=e[1],t=e[2],r=n[e[3]],o="",s="";isDigit(a)?(log("参数1是数字"),o="\nset2 a1 "+a+"\n"):o=dot_load((".load "+a+" a1").split(" ")),isDigit(t)?(log("参数2是数字"),s="\nset2 a2 "+t+"\n"):s=dot_load((".load "+t+" a2").split(" "));var _=o+s;return _+="\nadd2 a1 a2 a1\nset2 a3 "+r+"\nsubtract2 f1 a3 a3\nsave_from_register2 a1 a3\n"},dot_init=function(e){return"\njump @1024\n.memory 1024\nset2 f1 3 ;一开始设置到栈顶\njump #main ;直接跳到main函数\n"},if_scopes=[],dot_if=function(e){var n=e.split("\n")[0],a=n.indexOf("("),t=n.indexOf(")"),r=n.slice(a+1,t).split(" "),o=r[0],s=r[1],_=r[2];log(o,s,_);return e},process_if_while=function(e){e=e.split("\n");for(var n=0,a="";n<e.length;){if(code=clear_line(e[n]),0!=code.length)if(-1!=code.indexOf(".if")){for(var t="";-1==code.indexOf("}");)t+=code+"\n",++n,code=clear_line(e[n]);a+=dot_if(t+"}\n")+"\n"}else a+=code+"\n";++n}return a},translate_fake_ins=function(e){for(var n="",a=(e=e.split("\n"),0);a<e.length;){if(code=clear_line(e[a]),0!=code.length)if("}"==code[0]&&0!=if_scopes.length&&if_scopes.pop(),"."==code[0]&&-1==code.indexOf("memory")){code=code.split(" "),fake_ins=code[0];var t="";if(".call"==fake_ins)t="\nset2 a3 14\nadd2 pa a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\njump "+code[1];else if(".return"==fake_ins){t="set2 a3 "+(2+parseInt(code[1]))+"\nsubtract2 f1 a3 f1\nload_from_register2 f1 a3\njump_from_register a3 "}else".var"==fake_ins?t=dot_var(code):".function"==fake_ins?t=dot_function(code):".load"==fake_ins?t=dot_load(code):".assign"==fake_ins?t=dot_assign(code):".end_function"==fake_ins?t=dot_end_function(code):".call_function"==fake_ins?t=dot_call_function(code):".return_func"==fake_ins?t=dot_return_func(code):".load_return"==fake_ins?t=dot_load_return(code):".add"==fake_ins?t=dot_add(code):".init"==fake_ins?t=dot_init(code):".if"==fake_ins&&(t=dot_if(code));n+=t+"\n"}else 0!=code.length&&(n+=code+"\n");a++}return n};
