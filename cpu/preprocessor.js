"use strict";var update_label_map=function(n){for(var e=Object.keys(n),a=0;a<e.length;++a)n[e[a]]+=2;return n},scopes=[],get_scopes_top=function(){return scopes[scopes.length-1]},del_scopes_top=function(){return scopes.pop()},get_cur_scope=function(){return get_scopes_top().scope},get_cur_func_name=function(){return get_scopes_top().function_name},dot_function=function(n){var e=n[1];log("函数名:",e);var a=new Map;a.function_name=e;for(var t=new Map,e="#"+e,r=n.slice(2),s=0;s<r.length;++s)t[r[s]]=0,update_label_map(t);return a.scope=t,scopes.push(a),e},dot_end_function=function(n){n="#end_"+n[1];return del_scopes_top(),n},dot_var=function(n){var e=get_cur_scope();if(!(n.length<2)){var a=n[1],t=0;null!=e[a]&&assert(!1,"变量已定义"),3==n.length&&(t=n[2]),e[a]=0;t="set2 a3 "+t+"\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n";return update_label_map(e),t}assert(!1,".var语法错误")},dot_load=function(n){var e=get_cur_scope(),a=n[1],n=n[2];return"\nset2 a3 "+e[a]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 "+n},dot_assign=function(n){var e=get_cur_scope(),a=n[1];return"set2 a3 "+e[n[2]]+"\nsubtract2 f1 a3 a3\nsave_from_register2 "+a+" a3 "},dot_call_function=function(n){for(var e=n[1],a=n.slice(2),t=get_cur_scope(),r=0,s=0,_=0;_<a.length;++_)isDigit(a[_])?s+=15:r+=22;n=r+s+14;update_label_map(t);for(var o="set2 a3 "+n+"\nadd2 pa a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n",_=0;_<a.length;++_)isDigit(a[_])?s+=15:(o+="\nset2 a3 "+t[a[_]]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\n",update_label_map(t));return o+="jump #"+e,log("scopes:",scopes),o},dot_return_func=function(n){var e=get_cur_scope(),a=2*Object.keys(e).length,t=null,r="";return null!=(t=2<=n.length?n[1]:t)?null!=e[t]&&(r="set2 a3 "+e[t]+"\nsubtract2 f1 a3 a3\nload_from_register2 a3 a1\nset2 a3 "+a+"\nsubtract2 f1 a3 f1 ;f1退栈\nsave_from_register2 a1 f1\nset2 a3 2\nsubtract2 f1 a3 f1 ;再移回到返回值位置\nload_from_register2 f1 a3\njump_from_register a3\n"):r="main"==get_cur_func_name()?"set2 a3 "+a+"\nsubtract2 f1 a3 f1 ;f1退栈\n":"set2 a3 "+(a+=2)+"\nsubtract2 f1 a3 f1 ;f1退栈\nload_from_register2 f1 a3\njump_from_register a3\n",r},dot_load_return=function(n){var e=get_cur_scope();if(!(n.length<2)){n=n[1];null!=e[n]&&assert(!1,"load_return中变量未定义"),e[n]=0;return update_label_map(e),"\nset2 a3 2\nadd2 f1 a3 a3\nload_from_register2 a3 a3\nsave_from_register2 a3 f1 ;把值放到f1处\nset2 a3 2\nadd2 f1 a3 f1\n"}assert(!1,".load_return语法错误")},dot_add=function(n){n.length<4&&assert(!1,"add语法出错");var e=get_cur_scope(),a=n[1],t=n[2],n=e[n[3]],t=(isDigit(a)?(log("参数1是数字"),"\nset2 a1 "+a+"\n"):dot_load((".load "+a+" a1").split(" ")))+(isDigit(t)?(log("参数2是数字"),"\nset2 a2 "+t+"\n"):dot_load((".load "+t+" a2").split(" ")));return t+="\nadd2 a1 a2 a1\nset2 a3 "+n+"\nsubtract2 f1 a3 a3\nsave_from_register2 a1 a3\n"},dot_init=function(n){return"\njump @1024\n.memory 1024\nset2 f1 3 ;一开始设置到栈顶\njump #main ;直接跳到main函数\n"},if_scopes=[],dot_if=function(n){var e=n.split("\n")[0],a=e.indexOf("("),t=e.indexOf(")"),e=e.slice(a+1,t).split(" "),a=e[0],t=e[1],e=e[2];log(a,t,e);return n},process_if_while=function(n){for(var n=n.split("\n"),e=0,a="";e<n.length;){if(code=clear_line(n[e]),0!=code.length)if(-1!=code.indexOf(".if")){for(var t="";-1==code.indexOf("}");)t+=code+"\n",++e,code=clear_line(n[e]);a+=dot_if(t+"}\n")+"\n"}else a+=code+"\n";++e}return a},translate_fake_ins=function(n){for(var e="",n=n.split("\n"),a=0;a<n.length;){var t,r=clear_line(n[a]);0!=r.length&&("}"==r[0]&&0!=if_scopes.length&&if_scopes.pop(),"."==r[0]&&-1==r.indexOf("memory")?(r=r.split(" "),fake_ins=r[0],t="",".call"==fake_ins?t="\nset2 a3 14\nadd2 pa a3 a3\nsave_from_register2 a3 f1\nset2 a3 2\nadd2 f1 a3 f1\njump "+r[1]:".return"==fake_ins?t="set2 a3 "+(2+parseInt(r[1]))+"\nsubtract2 f1 a3 f1\nload_from_register2 f1 a3\njump_from_register a3 ":".var"==fake_ins?t=dot_var(r):".function"==fake_ins?t=dot_function(r):".load"==fake_ins?t=dot_load(r):".assign"==fake_ins?t=dot_assign(r):".end_function"==fake_ins?t=dot_end_function(r):".call_function"==fake_ins?t=dot_call_function(r):".return_func"==fake_ins?t=dot_return_func(r):".load_return"==fake_ins?t=dot_load_return(r):".add"==fake_ins?t=dot_add(r):".init"==fake_ins?t=dot_init(r):".if"==fake_ins&&(t=dot_if(r)),e+=t+"\n"):0!=r.length&&(e+=r+"\n")),a++}return e};