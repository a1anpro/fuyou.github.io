window.breakpoints={};var asmEditor=CodeMirror.fromTextArea(e("#asm_code"),{lineNumbers:!0,lineWrapping:!0,styleActiveLine:!0,styleSelectedText:!0,styleActiveSelected:!0,gutters:["breakpoints","CodeMirror-linenumbers"],mode:"text/x-z80",matchBrackets:!0,autoCloseBrackets:!0,theme:"darcula"}),mcodeEditor=CodeMirror.fromTextArea(e("#machine_code"),{mode:"text/x-z80",readOnly:!0,lineWrapping:!0,lineNumbers:!0,theme:"darcula"});asmEditor.setSize("auto",600),mcodeEditor.setSize("auto",500),asmEditor.on("gutterClick",function(e,n,t,a){null!=e.lineInfo(n).gutterMarkers?clearGutter(e,n):setGutter(e,n)});var clearGutter=function(e,n){delete window.breakpoints[n],e.setGutterMarker(n,"breakpoints",null)},setGutter=function(e,n){window.breakpoints[n]=!0;var t=getGutterMarker();e.setGutterMarker(n,"breakpoints",t)},getGutterMarker=function(){var e=document.createElement("div");return e.style.color="#00ff00",e.innerHTML="&nbsp▶ ",e},showStdCode=function(e,n){e.setValue(n)},showMachineCode=function(e,n){for(var t="",a="",r=0;r<n.length;++r){let e=n[r],o=parseInt(e).toString(2),i=8-o.length;for(let e=0;e<i;++e)o="0"+o;a=a+o+"\n",t=t+(o+"\t("+e+")")+"\n"}e.setValue(t)},success_highlight=function(e,n){e.addLineClass(n,"wrap","success-highlight-background")},highlight=function(e,n){e.addLineClass(n,"wrap","highlight-background")},remove_highlight=function(e,n){e.removeLineClass(n,"wrap","highlight-background")},select=function(e,n){e.setCursor(n),e.addLineClass(n,"wrap","highlight-background")},change_editor=function(){var e=asmEditor.getValue(),n=Assembler.new(e);n.run(),code_memory=n.get_machine_code(),std_code=n.get_std_code(),code_length=code_memory.length,mcode_lines=n.get_mcode_lines(),label_map=n.get_labelmap(),showStdCode(mcodeEditor,std_code)},paPos=[],code_memory=[],code_length=0,mcode_lines=[],label_map=null,running=!1,pa=null,axepu=null,debug_mode=!1,find_breakpoint=!1,finished=!1,registers=null,memory=null,memory_table=e("#memory-table");asmEditor.on("change",function(){change_editor()}),e("#run-button").onclick=function(){if(has_breakpoints()&&(debug_mode=!0),axepu=new AxePu(code_memory),pa=0,running=!0,paPos=[],1==debug_mode)for(;pa<mcode_lines.length;){for(var e in window.breakpoints)if(e==mcode_lines[pa]){find_breakpoint=!0;break}if(find_breakpoint)break;axepu.do_next_ins(),pa=axepu.get_register("pa")}},e("#next-button").onclick=function(){1==running&&(update_table(),run_next())},e("#stop-button").onclick=function(){log("点击停止"),running=!1},e("#reset-button").onclick=function(){change_editor(),running=!1,pa=null,axepu=null,debug_mode=!1,find_breakpoint=!1,finished=!1,paPos=[],reset_all()},e("#continue-button").onclick=function(){for(var e=mcode_lines[pa],n=Object.keys(window.breakpoints),t=e,a=0;a<n.length;++a)if(t<n[a]){t=n[a];break}for(log("下一个断点:",t);e<t;)run_next(),e=mcode_lines[pa]};var has_breakpoints=function(){for(var e in window.breakpoints)return!0;return!1},reset_all=function(){log("重置所有"),clear_registers_table(),clear_memory_table(),clear_all_highlight()},clear_registers_table=function(){for(var n=e("#registers-tr").children,t=0;t<n.length;++t){n[t].innerHTML=0}},clear_memory_table=function(){for(var n=e("#memory-table"),t=n.rows.length-1,a=0;a<t;++a){var r=n.rows[a+1];r.cells[0].removeAttribute("style"),r.cells[1].innerHTML=0}},update_registers_table=function(){if(null!=axepu)for(var n=axepu.get_all_registers(),t=e("#registers-tr").children,a=Object.keys(n),r=0;r<a.length;++r){var o=a[r];t[r].innerHTML=n[o]}},str_pad=function(e){var n=4-e.length;return"0X"+"0000".substr(0,n)+e.toUpperCase()},update_memory_table=function(){if(null!=axepu)for(var e=parseInt(registers.f1),n=memory.slice(0,1024),t=0;t<n.length;++t){var a=t,r=n[t],o=memory_table.rows[t+1];e==t?o.cells[0].setAttribute("style","background-color: red"):o.cells[0].removeAttribute("style"),o.cells[0].innerHTML=a+" ["+str_pad(a.toString(16))+"]",o.cells[1].innerHTML=r+" ["+str_pad(r.toString(16))+"]"}},highligh_current_line=function(){if(1==running){for(var e=0;e<mcode_lines.length;++e)remove_highlight(asmEditor,mcode_lines[e]),remove_highlight(mcodeEditor,e);pa<mcode_lines.length&&(highlight(asmEditor,mcode_lines[pa]),highlight(mcodeEditor,pa))}},clear_all_highlight=function(){for(var e=0;e<mcode_lines.length;++e)remove_highlight(asmEditor,mcode_lines[e]),remove_highlight(mcodeEditor,e)},finish_process=function(){log("执行完成的pa:",pa);var e=pa-1;log("有效代码:",mcode_lines),success_highlight(asmEditor,mcode_lines[e]),success_highlight(asmEditor,e)};showToast=((e,n,t)=>{e.addClass(n),e[0].innerHTML=t,e.fadeTo(2e3,500).slideUp(500,function(){e.hide()})});var run_next=function(){axepu.do_next_ins(),pa=axepu.get_register("pa"),paPos.length>=1e3?paPos=[]:paPos.push(pa);const e=paPos[paPos.length-1];let n=0;for(let t=paPos.length-1;t>=0;t-=1)e===paPos[t]&&(n+=1),n>=30&&(running=!1,axepu=null,showToast($("#alert-div"),"alert alert-danger","pa指向同一内存地址，可能超时！请重试"),log("timeout"));pa>=mcode_lines.length&&(running=!1,axepu=null,log("结束"))},update_mem_reg=function(){null!=axepu&&running&&(registers=axepu.get_all_registers(),memory=axepu.get_memory())},update_table=function(){update_registers_table(),update_memory_table(),highligh_current_line()};setInterval(function(){1==running&&(update_mem_reg(),update_table(),0==debug_mode&&run_next())},1e3/30);const _main=()=>{asmEditor.setValue("jump @1024\n.memory 1024\n\nset2 f1 3 ;一开始设置到栈顶\njump @function_end ;先去设置一下内存结构\n\n@function_multiply ;6\nset2 a3 2\nsave2 a1 @65534\n\n@while_start  ;15\ncompare a2 a3\njump_if_less @while_end\n\n; 用a2来给a3加1\nsave2 a2 @65532\nset2 a2 1\nadd2 a3 a2 a3\n\n; 把a1原来的值存起来在加\nload2 @65534 a2\nadd2 a1 a2 a1\n\nload2 @65532 a2\njump @while_start ;18\n@while_end ;47\n\nset2 a3 2\nsubtract2 f1 a3 f1\nload_from_register2 f1 a2\njump_from_register a2\n\n@function_end ;61\n\n;设置参数\nset2 a1 10\nset2 a2 3\n\nset2 a3 14 ;4字节,设置f1是调用函数之后返回的位置\nadd2 pa a3 a3 ;4字节\n\nsave_from_register2 a3 f1 ;3字节\nset2 a3 2 ;4字节\nadd2 f1 a3 f1 ;4字节\njump @function_multiply ;3字节,10\nhalt\n"),change_editor()};asmEditor.setValue("jump @1024\n.memory 1024\n\nset2 f1 3 ;一开始设置到栈顶\njump @function_end ;先去设置一下内存结构\n\n@function_multiply ;6\nset2 a3 2\nsave2 a1 @65534\n\n@while_start  ;15\ncompare a2 a3\njump_if_less @while_end\n\n; 用a2来给a3加1\nsave2 a2 @65532\nset2 a2 1\nadd2 a3 a2 a3\n\n; 把a1原来的值存起来在加\nload2 @65534 a2\nadd2 a1 a2 a1\n\nload2 @65532 a2\njump @while_start ;18\n@while_end ;47\n\nset2 a3 2\nsubtract2 f1 a3 f1\nload_from_register2 f1 a2\njump_from_register a2\n\n@function_end ;61\n\n;设置参数\nset2 a1 10\nset2 a2 3\n\nset2 a3 14 ;4字节,设置f1是调用函数之后返回的位置\nadd2 pa a3 a3 ;4字节\n\nsave_from_register2 a3 f1 ;3字节\nset2 a3 2 ;4字节\nadd2 f1 a3 f1 ;4字节\njump @function_multiply ;3字节,10\nhalt\n"),change_editor();
