"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var o=0,e=function(){};return{s:e,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return i=t.done,t},e:function(t){a=!0,n=t},f:function(){try{i||null==r.return||r.return()}finally{if(a)throw n}}}}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=new Array(e);r<e;r++)o[r]=t[r];return o}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var o,n,i=[],a=!0,u=!1;try{for(r=r.call(t);!(a=(o=r.next()).done)&&(i.push(o.value),!e||i.length!==e);a=!0);}catch(t){u=!0,n=t}finally{try{a||null==r.return||r.return()}finally{if(u)throw n}}return i}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(r){var o=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(r);return _possibleConstructorReturn(this,o?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var GuaCamera=function(){_inherits(r,GuaObject);var e=_createSuper(r);function r(){var t;return _classCallCheck(this,r),(t=e.call(this)).position=GuaVector.new(config.camera_position_x.value,config.camera_position_y.value,config.camera_position_z.value),t.target=GuaVector.new(config.camera_target_x.value,config.camera_target_y.value,config.camera_target_z.value),t.up=GuaVector.new(config.camera_up_x.value,config.camera_up_y.value,config.camera_up_z.value),t}return r}(),GuaCanvas=function(){_inherits(o,GuaObject);var r=_createSuper(o);function o(t){_classCallCheck(this,o);var e=r.call(this),t=_e(t);return e.canvas=t,self=_assertThisInitialized(e),e.canvas.addEventListener("click",function(t){var e=t.offsetX,r=t.offsetY,o=GuaVector.new(e,r,0),t=GuaColor.white(),t=GuaVertex.new(o,t);log(t),self.drawPoint(t),log(self._getPixel(e,r))}),e.context=t.getContext("2d"),e.w=t.width,e.h=t.height,e.depth=Array(e.w*e.h).fill(Number.MAX_SAFE_INTEGER),e.pixels=e.context.getImageData(0,0,e.w,e.h),e.bytesPerPixel=4,e.camera=GuaCamera.new(),e.debugCount=0,e.correction=!1,e.clear(),e}return _createClass(o,[{key:"render",value:function(){var t=this.pixels;this.context.putImageData(t,0,0)}},{key:"setCorrection",value:function(t){this.correction=t}},{key:"_getPixel",value:function(t,e){var r=Math.round;t=r(t);e=((e=r(e))*this.w+t)*this.bytesPerPixel,t=this.pixels.data,e=[t[e],t[1+e],t[2+e],t[3+e]];return GuaColor.new(e[0],e[1],e[2],e[3])}},{key:"_setPixel",value:function(t,e,r,o){var n=Math.round,i=n(t)+n(e)*this.w;r>this.depth[i]||(n=this._getPixel(t,e),o=o.mix(n),this.depth[i]=r,t=i*this.bytesPerPixel,e=this.pixels.data,r=(n=o).r,i=n.g,o=n.b,n=n.a,e[t]=r,e[1+t]=i,e[2+t]=o,e[3+t]=n)}},{key:"clear",value:function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:GuaColor.black(),e=this.w,r=this.h,o=0;o<e;o++)for(var n=0;n<r;n++)this._setPixel(o,n,0,t);this.depth=Array(this.w*this.h).fill(Number.MAX_SAFE_INTEGER),this.render()}},{key:"drawPoint",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:GuaColor.blue(),r=this.w,o=this.h;0<=t.x&&t.x<=r&&0<=t.y&&t.y<=o&&0!=e.a&&this._setPixel(t.x,t.y,t.z,e)}},{key:"debugPrint",value:function(t,e,r){this.debugCount<t&&(log("discription: $this.debugCount, ($content)"),this.debugCount+=1)}},{key:"drawLine",value:function(t,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:GuaColor.black(),o=[t.x,t.y,e.x,e.y,t.z,e.z],n=o[0],i=o[1],a=o[2],u=o[4],c=o[5],l=a-n,t=o[3]-i,s=Math.pow(Math.pow(l,2)+Math.pow(t,2),.5),e=0==l?void 0:t/l,f=0;f=void 0===e?(o=Math.PI/2,0<=t?o:-o):(t=Math.abs(t/s),t=Math.asin(0<=e?t:-t),0<l?t:t+Math.PI);for(var p=0;p<=s;p++){var y=n+Math.cos(f)*p,h=i+Math.sin(f)*p,v=a!=n?(y-n)/(a-n):0;this.drawPoint(GuaVector.new(y,h,u+(c-u)*v+.1),r)}}},{key:"drawScanline",value:function(t,e,r,o){for(var e=_slicedToArray([t,e].sort(function(t,e){return t.position.x-e.position.x}),2),n=e[0],i=e[1],a=n.position.y,u=n.position.x,c=i.position.x,l=u;l<=c;l++){var s=0,f=n.interpolate(i,s=c!=u?(l-u)/(c-u):s,this.correction),p=f.position.z,y=f.u,s=f.v,f=f.color;null!=r&&(f=r.getColor(y,s)),null!=o&&(f.r*=o,f.g*=o,f.b*=o),this.drawPoint(GuaVector.new(l,a,p),f)}}},{key:"drawTriangle",value:function(t,e,r,o,n){var r=_slicedToArray([t,e,r].sort(function(t,e){return t.position.y-e.position.y}),3),i=r[0],a=r[1],u=r[2],r=0;u.position.y-i.position.y!=0&&(r=(a.position.y-i.position.y)/(u.position.y-i.position.y));for(var c=i.interpolate(u,r,this.correction),l=i.position.y,s=a.position.y,f=l;f<=s;f+=1){var p=0,y=i.interpolate(c,p=s!=l?(f-l)/(s-l):p,this.correction),p=i.interpolate(a,p,this.correction);this.drawScanline(y,p,o,n)}for(var l=a.position.y+1e-4,s=u.position.y,h=l;h<=s;h+=1){var v=0,_=c.interpolate(u,v=s!=l?(h-l)/(s-l):v,this.correction),v=a.interpolate(u,v,this.correction);this.drawScanline(_,v,o,n)}}},{key:"project",value:function(t,e){var r=this.w/2,o=this.h/2,n=e.transform(t.position),i=n.x*r+r,e=-n.y*o+o,r=2*n.z+2,o=n.w,n=t.normal,e=GuaVector.new(i,e,r,o),r=t.color,o=t.u,t=t.v;return GuaVertex.new(e,r,o,t,n)}},{key:"projectVector",value:function(t,e){var r=this.w/2,o=this.h/2,t=e.transform(t),r=t.x*r+r,o=-t.y*o+o,t=t.z;return GuaVector.new(r,o,t,pw)}},{key:"drawLight",value:function(t){var e=GuaColor.white(),r=GuaVertex.new(GuaVector.new(t.x,t.y-20,1),e),o=GuaVertex.new(GuaVector.new(t.x-20,t.y+20,1),e),e=GuaVertex.new(GuaVector.new(t.x+20,t.y+20,1),e);this.drawTriangle(r,o,e)}},{key:"drawMesh",value:function(t,e){this.drawLight(e);for(var r=this,o=this.w,n=this.h,i=r.camera,a=i.position,u=i.target,i=i.up,u=Matrix.lookAtLH(a,u,i),i=Matrix.perspectiveFovLH(.8,o/n,.1,1),o=Matrix.rotation(t.rotation),n=Matrix.translation(t.position),c=o.multiply(n),l=c.multiply(u).multiply(i),s=0;s<t.triangles.length;s++){var f=_slicedToArray(t.triangles[s],3),p=f[0],y=f[1],h=f[2],v=GuaVector.core(p.position,y.position,h.position),v=c.transform(v).normalize(),f=(f=GuaVector.core(p.normal,y.normal,h.normal)).normalize(),v=e.sub(v).normalize(),f=GuaVector.cos(v,f),f=Math.abs(f)+.4,p=_slicedToArray([p,y,h].map(function(t){return r.project(t,l)}),3),y=p[0],h=p[1],p=p[2];r.drawTriangle(y,h,p,t.axeimage,f)}}},{key:"drawMesh1",value:function(e){var t,r=this,o=this.w,n=this.h,i=r.camera,a=i.position,u=i.target,i=i.up,u=Matrix.lookAtLH(a,u,i),i=Matrix.perspectiveFovLH(.8,o/n,.1,1),o=Matrix.rotation(e.rotation),n=Matrix.translation(e.position),c=o.multiply(n).multiply(u).multiply(i),l=_createForOfIteratorHelper(e.indices);try{for(l.s();!(t=l.n()).done;){var s=_slicedToArray(t.value.map(function(t){return e.vertices[t]}),3),f=_slicedToArray([s[0],s[1],s[2]].map(function(t){return r.project(t,c)}),3),p=f[0],y=f[1],h=f[2];r.drawLine(p.position,y.position),r.drawLine(p.position,h.position),r.drawLine(y.position,h.position)}}catch(t){l.e(t)}finally{l.f()}}}]),o}();