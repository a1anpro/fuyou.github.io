"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(r="Object"===r&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=new Array(e);r<e;r++)o[r]=t[r];return o}function _iterableToArrayLimit(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var o,n,i=[],a=!0,u=!1;try{for(r=r.call(t);!(a=(o=r.next()).done)&&(i.push(o.value),!e||i.length!==e);a=!0);}catch(t){u=!0,n=t}finally{try{a||null==r.return||r.return()}finally{if(u)throw n}}return i}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _createSuper(r){var o=_isNativeReflectConstruct();return function(){var t,e=_getPrototypeOf(r);return _possibleConstructorReturn(this,o?(t=_getPrototypeOf(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments))}}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var GuaCamera=function(){_inherits(r,GuaObject);var e=_createSuper(r);function r(){var t;return _classCallCheck(this,r),(t=e.call(this)).position=GuaVector.new(config.camera_position_x.value,config.camera_position_y.value,config.camera_position_z.value),t.target=GuaVector.new(config.camera_target_x.value,config.camera_target_y.value,config.camera_target_z.value),t.up=GuaVector.new(config.camera_up_x.value,config.camera_up_y.value,config.camera_up_z.value),t}return r}(),GuaCanvas=function(){_inherits(o,GuaObject);var r=_createSuper(o);function o(t){_classCallCheck(this,o);var e=r.call(this),t=_e(t);return e.canvas=t,e.context=t.getContext("2d"),e.w=t.width,e.h=t.height,e.depth=Array(e.w*e.h).fill(Number.MAX_SAFE_INTEGER),e.pixels=e.context.getImageData(0,0,e.w,e.h),e.bytesPerPixel=4,e.camera=GuaCamera.new(),e.cnt=0,e}return _createClass(o,[{key:"render",value:function(){var t=this.pixels;this.context.putImageData(t,0,0)}},{key:"_getPixel",value:function(t,e){var r=Math.round;t=r(t);e=((e=r(e))*this.w+t)*this.bytesPerPixel,t=this.pixels.data,e=[t[e],t[1+e],t[2+e],t[3+e]];return GuaColor.new(e[0],e[1],e[2],e[3])}},{key:"_setPixel",value:function(t,e,r,o){var n=Math.round;t=n(t);n=(e=n(e))*this.w+t;r>this.depth[n]&&(i=this._getPixel(t,e),o=GuaColor.mix(o,i),this.cnt<1e3&&this.cnt++),log(o),this.depth[n]=r;var t=n*this.bytesPerPixel,e=this.pixels.data,i=o,r=i.r,n=i.g,o=i.b,i=i.a;e[t]=r,e[1+t]=n,e[2+t]=o,e[3+t]=i}},{key:"clear",value:function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:GuaColor.white(),e=this.w,r=this.h,o=0;o<e;o++)for(var n=0;n<r;n++)this._setPixel(o,n,0,t);this.depth=Array(this.w*this.h).fill(Number.MAX_SAFE_INTEGER)}},{key:"drawPoint",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:GuaColor.black(),r=this.w,o=this.h;0<=t.x&&t.x<=r&&0<=t.y&&t.y<=o&&0!=e.a&&this._setPixel(t.x,t.y,t.z,e)}},{key:"drawLine",value:function(t,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:GuaColor.black(),o=[t.x,t.y,e.x,e.y,t.z,e.z],n=o[0],i=o[1],a=o[2],u=o[4],l=o[5],s=a-n,t=o[3]-i,c=Math.pow(Math.pow(s,2)+Math.pow(t,2),.5),e=0==s?void 0:t/s,f=0;f=void 0===e?(o=Math.PI/2,0<=t?o:-o):(t=Math.abs(t/c),t=Math.asin(0<=e?t:-t),0<s?t:t+Math.PI);for(var p=0;p<=c;p++){var y=n+Math.cos(f)*p,h=i+Math.sin(f)*p,_=a!=n?(y-n)/(a-n):0;this.drawPoint(GuaVector.new(y,h,u+(l-u)*_+.1),r)}}},{key:"drawScanline",value:function(t,e,r){for(var e=_slicedToArray([t,e].sort(function(t,e){return t.position.x-e.position.x}),2),o=e[0],n=e[1],i=o.position.y,a=o.position.x,u=n.position.x,l=a;l<=u;l++){var s=0,c=o.interpolate(n,s=u!=a?(l-a)/(u-a):s),f=c.position.z,p=c.u,s=c.v,c=c.color;null!=r&&(c=r.getColor(p,s)),this.drawPoint(GuaVector.new(l,i,f),c)}}},{key:"drawTriangle",value:function(t,e,r,o){var r=_slicedToArray([t,e,r].sort(function(t,e){return t.position.y-e.position.y}),3),n=r[0],i=r[1],a=r[2],r=0;a.position.y-n.position.y!=0&&(r=(i.position.y-n.position.y)/(a.position.y-n.position.y));for(var u=n.interpolate(a,r),l=n.position.y,s=i.position.y,c=l;c<=s;c+=.5){var f=0,p=n.interpolate(u,f=s!=l?(c-l)/(s-l):f),f=n.interpolate(i,f);this.drawScanline(p,f,o)}for(var l=i.position.y+.001,s=a.position.y,y=l;y<=s;y+=1){var h=0,_=u.interpolate(a,h=s!=l?(y-l)/(s-l):h),h=i.interpolate(a,h);this.drawScanline(_,h,o)}}},{key:"project",value:function(t,e){var r=this.w/2,o=this.h/2,e=e.transform(t.position),r=e.x*r+r,o=-e.y*o+o,e=GuaVector.new(r,o,e.z);return GuaVertex.new(e,t.color,t.u,t.v)}},{key:"drawMesh",value:function(t){for(var e=this,r=this.w,o=this.h,n=e.camera,i=n.position,a=n.target,n=n.up,a=Matrix.lookAtLH(i,a,n),n=Matrix.perspectiveFovLH(.8,r/o,.1,1),r=Matrix.rotation(t.rotation),o=Matrix.translation(t.position),u=r.multiply(o).multiply(a).multiply(n),l=0;l<t.triangles.length;l++){var s=_slicedToArray(t.triangles[l],3),c=_slicedToArray([s[0],s[1],s[2]].map(function(t){return e.project(t,u)}),3),f=c[0],s=c[1],c=c[2];e.drawTriangle(f,s,c,t.axeimage)}}}]),o}();